\chapter{MGXS Generation with Monte Carlo}
\label{chap:mgxs-mc}

In the preceding chapter it was observed that many approximations are made in multi-group theory and the generation of multi-group cross sections. Monte Carlo is an approach to replace some of the steps in the standard multi-level framework for \ac{MGXS} generation with a natural and reactor agnostic treatment of energy and spatial self-shielding. This chapter presents a brief overview of \ac{MC} tallies and statistics in Sec.~\ref{sec:chap3-mc-overview}, and Sec.~\ref{sec:chap3-mgxs-gen} outlines the necessary computation needed to generate \ac{MGXS} with \ac{MC}. Sec.~\ref{sec:chap3-lit-review} discusses past work to apply \ac{MC} for \ac{MGXS} generation, while Sec.~\ref{sec:chap3-latent-variables} introduces a new approach based on a latent variable model for spatial self-shielding.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Overview of Monte Carlo Methods}
\label{sec:chap3-mc-overview}

Monte Carlo methods have been successfully applied to neutron transport calculations for many decades. A detailed accounting of the physics models and algorithms used in \ac{MC} methods can be found in the manuals for the MCNP~\cite{mcnpx2003manual}, Serpent~\cite{serpent2013manual} and OpenMC~\cite{openmc2016manual} Monte Carlo particle transport codes. This section presents a few key aspects related to tallies and statistics, and follows directly from the manual for the OpenMC~\cite{openmc2016manual} code which is used throughout this work.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Monte Carlo Tallies}
\label{subsec:chap3-mc-tallies}

\ac{MC} simulations sample the particle distribution in order to compute integral quantities of interest called \textit{tallies}. A tally is an integral of a \textit{scoring function} $f$ weighted by the neutron distribution, or flux, across some region of phase space. A general form for tally $\mathcal{T}$ is given by the following integral expression:

\begin{dmath}
\label{eqn:chap3-tallies-general}
\mathcal{T} = \int_{V} \int_{S} \int_{E}  f(\mathbf{r},\mathbf{\Omega},E)\psi(\mathbf{r},\mathbf{\Omega},E)\mathrm{d}E\mathrm{d}\mathbf{\Omega}\mathrm{d}\mathbf{r} 
\end{dmath}

In OpenMC parlance, the integration bounds over space, angle and energy are termed \textit{filters}, while the scoring function $f$ is simply known as a \textit{score}. Various scores may be used to compute volume-integrated fluxes, reaction rates, functional expansions and more. \ac{MC} does not perform the integration in Eqn.~\ref{eqn:chap3-tallies-general} with the exact flux specified at all points in phase space. Instead, \ac{MC} performs stochastic integration by sampling the particle population across the entirety of phase space to compute a \textit{statistical estimate} $\hat{\mathcal{T}}$ of the true integral $\mathcal{T}$.

There are a number of different techniques to estimate a tally. The first and most general method is known as an \textit{analog estimator}. An analog estimator $\hat{\mathcal{T}}$ increments a tally by the particle weight $w_{i}$ each time an event $i$ occurs from the set of all events of interest $A$ (\textit{e.g.}, fission events). The sum of particle weights is then normalized by the total weight of all particles $W$ to compute the interaction frequency on a per-particle basis within the phase space volume of interest:

\begin{dmath}
\label{eqn:chap3-tallies-analog}
\hat{\mathcal{T}} = \frac{1}{W}\displaystyle\sum\limits_{i \in A} w_{i}
\end{dmath}

Although analog estimators permit general filters and scoring functions, they may suffer from poor tallying efficiency if the size of set $A$ is very small compared to the total number of events in a simulation. A \textit{collision estimator} improves the tallying efficiency by incrementing a tally more frequently than is possible with analog estimators. In particular, a collision estimator increments a tally at each collision $i$ from the set of all collisions $C$ irregardless of the types of collisions that took place. By noting that the total collision rate is given by $R_{t} = \Sigma_{t}\phi$, a collision estimator for the flux $\hat{\phi}$ may be simply defined by dividing the particle weights by the total macroscopic cross section:

\begin{dmath}
\label{eqn:chap3-tallies-collision-flux}
\hat{\phi} = \frac{1}{W}\displaystyle\sum\limits_{i \in C}\frac{w_{i}}{\Sigma_{t}(E_{i})}
\end{dmath}

\noindent The collision estimator depends on the energy of the incoming particle $E_{i}$ in order to scale the particle weight by the energy-dependent total cross section. It follows that the collision estimator for a reaction rate $\hat{\mathcal{R}}_{x}$ is the product of the flux in Eqn.~\ref{eqn:chap3-tallies-collision-flux} and the cross section for the reaction type $x$ of interest:

\begin{dmath}
\label{eqn:chap3-tallies-collision-rxn}
\hat{\mathcal{R}}_{x} = \frac{1}{W}\displaystyle\sum\limits_{i \in C}\frac{w_{i}\Sigma_{x}(E_{i})}{\Sigma_{t}(E_{i})}
\end{dmath}

The collision estimator increases the number of events in $C$ to improve the tallying efficiency with respect to analog tallies. A third known as \textit{track-length estimators} goes one step further and increments a tally each time a particle trajectory crosses the phase space of interest (\textit{e.g.}, a spatial tally mesh zone) even if a collision did not take place. The track-length estimator makes use of a particle's distance travelled $\Delta\mathbf{r}$ to estimate the flux. A track-length estimator of the flux is therefore:

\begin{dmath}
\label{eqn:chap3-tallies-tracklength-flux}
  \hat{\phi} = \frac{1}{W}\displaystyle\sum\limits_{i \in T}w_{i}\Delta\mathbf{r}_{i}
\end{dmath}

\noindent where the set $T$ represents each particle trajectory through the phase space volume of interest. Similarly, a track-length estimate of a reaction rate $x$ can be found from simply multiplying the flux in Eqn.~\ref{eqn:chap3-tallies-tracklength-flux} by the cross section:

\begin{dmath}
\label{eqn:chap3-tallies-tracklength-rxn}
  \hat{\mathcal{R}}_{x} = \frac{1}{W}\displaystyle\sum\limits_{i \in T}w_{i}\Delta\mathbf{r}_{i}\Sigma_{x}(E_{i})
\end{dmath}

The tallying efficiency for track-length estimators is greatly improved by incrementing a tally for each particle trajectory. As a result, the confidence intervals are generally much tighter for track-length estimators than those for analog and collision estimators. 

Each of the three estimators -- analog, collision and track-length -- may be useful for different scenarios. Although track-length and collision estimators improve statistics over analog estimates, they cannot be employed for all types of filters. For example, track-length tallies may not be used if the scoring function requires information about the outgoing particle since this is not available unless a collision took place. As discussed in Sec.~\ref{sec:chap3-mgxs-gen}, a mixture of estimators which tradeoff generality with efficiency must be used to generate \ac{MGXS} from \ac{MC} tallies.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Sample Statistics}
\label{subsec:chap3-mc-stats}

As discussed in the preceding section, \ac{MC} performs stochastic integration with one of a number of different estimators. In each case, the tally estimator $\hat{\mathcal{T}}$ is computed as a sample mean of of all of the events or particle trajectories simulated. An unbiased estimate of the sample mean is given by:

\begin{equation}
\label{eqn:chap3-sample-mean}
\bar{x} = \frac{1}{N} \displaystyle\sum\limits_{i=1}^{N} x_{i}
\end{equation}

\noindent where each of the $N$ samples is given by a random variable $x_{i}$. For \ac{MC} codes that used batch-based statistics, such as OpenMC, $N$ is the number of batches of particles simulated and $x_{i}$ is the tally estimator for the $i$\textsuperscript{th} batch of particles. 

Each of the random variables $x_{i}$ is sampled from some probability distribution representative of the physics in the simulation. The sampling distribution is normal and $x_{i} \sim \mathcal{N}(\mu,\sigma^{2})$ where $\mathcal{N}(\mu,\sigma^{2})$ signifies a normal distribution with mean $\mu$ and variance $\sigma^{2}$ if each batch of particles is independent. An unbiased estimate of the variance $\sigma^{2}$ of the distribution from which the population $x_{i}$ is drawn may be estimated using Bessel's correction for the sample variance $s^{2}$:

\begin{equation}
\label{eqn:chap3-variance-sample}
s^{2} = \frac{1}{N-1}\displaystyle\sum\limits_{i=1}^{N}\left(x_{i} - \bar{x}\right)^{2}
\end{equation}

\noindent As $N \rightarrow \infty$ the population variance estimator will approach the true variance $\sigma^{2}$ of the underlying distribution. In the case of batch-based statistics, the variance $\sigma^{2}$ will be determined by the number of particles simulated per batch -- the more particle histories simulated per batch, the smaller $\sigma^{2}$ will be, and vice versa.

In general, it is more useful to quantify the uncertainty of a tally estimator than it is to compute the sample variance. The variance of the sample mean is representative of the distribution from which the random variable $\bar{x}$ is drawn and indicates the degree of confidence one may have in a tally estimator. By the Central Limit Theorem, the sample mean $\bar{x}$ will converge to the mean of a normal distribution if the samples $x_{i}$ are uncorrelated. An unbiased estimate of the variance of the sample mean can be derived from the Bienaym\'{e} formula to give:

\begin{equation}
\label{eqn:chap3-variance-mean}
s_{\bar{x}}^{2} = \frac{1}{N-1}\left(\frac{1}{N}\displaystyle\sum\limits_{i=1}^{N}
x_{i}^{2} - \bar{x}^2\right)
\end{equation}

The key observation is that the standard deviation of the sample mean varies as $s_{\bar{x}} \propto \nicefrac{1}{\sqrt{N}}$ if the samples $x_{i}$ are uncorrelated. This necessarily implies that the uncertainties on a tally estimator can be made arbitrarily small given enough simulated particle histories. However, recent studies have shown that batch-based tally estimators in eigenvalue calculations are not generally independent and identically distributed realizations due to correlated fission sources between batches~\cite{herman2014correlation,miao2016correlation}. 

%A pivotal $t$-statistic may be used to compute $1 - \alpha$ confidence intervals for the sample mean.

%\begin{equation}
%\label{eqn:chap3-conv-rate}
%s_{\bar{x}} = \frac{\sigma}{\sqrt{N}} \approx \frac{s}{\sqrt{N}}
%\end{equation}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{\ac{MGXS} Generation with Monte Carlo}
\label{sec:chap3-mgxs-gen}



DIY \ac{MGXS} generation with \ac{MC} \\
Stochastic approx. to integrals in Section~\ref{sec:chap2-background} \\


%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Tally Types Needed for \ac{MGXS} Generation}
\label{subsec:chap3-tally-types}

\begin{itemize}[noitemsep]
  \item recall flux separability approx.
\end{itemize}

\subsubsection{General Form}
\label{subsubsec:chap3-gen-xs}

\subsubsection{Total and Transport Cross Sections}
\label{subsubsec:chap3-tot-xs}

\subsubsection{Scattering Matrices}
\label{subsubsec:chap3-scatt-mat}

\begin{itemize}[noitemsep]
  \item refer to adam/redmond's thesis for more details on scattering moments
\end{itemize}

\subsubsection{Fission Production Cross Sections}
\label{subsubsec:chap3-fiss-prod}

\subsubsection{Chi Fission Spectrum}
\label{subsubsec:chap3-chi}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Uncertainty Propagation}
\label{subsec:chap3-uncertainty-prop}

\begin{itemize}[noitemsep]
  \item uncertainty propagation eqns
  \item need a reference
  \item https://en.wikipedia.org/wiki/Propagation_of_uncertainty
\end{itemize}

define covariance\\
two random variables $X$ and $Y$ with standard deviations $\sigma_{X}$ and $\sigma_{Y}$\\

\begin{equation}
Z = aX \qquad,\qquad \sigma_{Z}^{2} = a^{2}\sigma_{X}^{2}
\end{equation}

\begin{equation}
Z = X + Y \qquad,\qquad \sigma_{Z}^{2} = \sigma_{X}^{2} + \sigma_{Y}^{2} + 2\sigma_{XY}
\end{equation}

\begin{equation}
Z = X - Y \qquad,\qquad \sigma_{Z}^{2} = \sigma_{X}^{2} + \sigma_{Y}^{2} - 2\sigma_{XY}
\end{equation}

\begin{equation}
Z = XY \qquad,\qquad \sigma_{Z}^{2} \approx Z^{2}\left[\left(\frac{\sigma_{X}}{X}\right)^{2} + \left(\frac{\sigma_{Y}}{Y}\right)^{2} + 2\frac{\sigma_{XY}}{Z}\right] \approx Z^{2}\left[\left(\frac{\sigma_{X}}{X}\right)^{2} + \left(\frac{\sigma_{Y}}{Y}\right)^{2}\right]
\end{equation}

\begin{equation}
Z = \frac{X}{Y} \qquad,\qquad \sigma_{Z}^{2} \approx Z^{2}\left[\left(\frac{\sigma_{X}}{X}\right)^{2} + \left(\frac{\sigma_{Y}}{Y}\right)^{2} - 2\frac{\sigma_{XY}}{Z}\right] \approx Z^{2}\left[\left(\frac{\sigma_{X}}{X}\right)^{2} + \left(\frac{\sigma_{Y}}{Y}\right)^{2}\right]
\end{equation}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Review of Previous Efforts}
\label{sec:chap3-lit-review}

\begin{itemize}[noitemsep]
  \item \ac{MGXS} for coarse mesh diffusion
  \begin{itemize}[noitemsep]
    \item Serpent
    \item Redmond
    \item Pounders
  \end{itemize}
  \item \ac{MGXS} for fine mesh transport
  \begin{itemize}[noitemsep]
    \item Nelson with NDPP
  \end{itemize}
\end{itemize}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{A New Approach: A Latent Variable Model}
\label{sec:chap3-latent-variables}

\begin{itemize}[noitemsep]
  \item tally ``noise'' model
  \item spatial self-shielding treatment is natural in \ac{MC}
  \item challenge is slow convergence rate
  \item motivate clustering
\end{itemize}