\chapter{MGXS Generation with Monte Carlo}
\label{chap:mgxs-mc}

In the preceding chapter it was observed that many approximations are made in multi-group theory and the generation of multi-group cross sections. Monte Carlo is an approach to replace some of the steps in the standard multi-level framework for \ac{MGXS} generation with a natural and reactor agnostic treatment of energy and spatial self-shielding. This chapter presents a brief overview of \ac{MC} tallies and statistics in Sec.~\ref{sec:chap3-mc-overview}, and Sec.~\ref{sec:chap3-mgxs-gen} outlines the necessary computation needed to generate \ac{MGXS} with \ac{MC}. Sec.~\ref{sec:chap3-lit-review} discusses past work to apply \ac{MC} for \ac{MGXS} generation, while Sec.~\ref{sec:chap3-latent-variables} introduces a new approach based on a latent variable model for spatial self-shielding.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Overview of Monte Carlo Methods}
\label{sec:chap3-mc-overview}

Monte Carlo methods have been successfully applied to neutron transport calculations for many decades. A detailed accounting of the physics models and algorithms used in \ac{MC} methods can be found in the manuals for the MCNP~\cite{mcnpx2003manual}, Serpent~\cite{serpent2013manual} and OpenMC~\cite{openmc2016manual} Monte Carlo particle transport codes. This section presents a few key aspects related to tallies and statistics, and follows directly from the manual for the OpenMC~\cite{openmc2016manual} code which is used throughout this work.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Monte Carlo Tallies}
\label{subsec:chap3-mc-tallies}

\ac{MC} simulations sample the particle distribution in order to compute integral quantities of interest called \textit{tallies}. A tally is an integral of a \textit{scoring function} $f$ weighted by the neutron distribution, or flux, across some region of phase space. A general form for tally $\mathcal{T}$ is given by the following integral expression:

\begin{dmath}
\label{eqn:chap3-tallies-general}
\mathcal{T} = \int_{V} \int_{S} \int_{E}  f(\mathbf{r},\mathbf{\Omega},E)\psi(\mathbf{r},\mathbf{\Omega},E)\mathrm{d}E\mathrm{d}\mathbf{\Omega}\mathrm{d}\mathbf{r} 
\end{dmath}

In OpenMC parlance, the integration bounds over space, angle and energy are termed \textit{filters}, while the scoring function $f$ is simply known as a \textit{score}. Various scores may be used to compute volume-integrated fluxes, reaction rates, functional expansions and more. \ac{MC} does not perform the integration in Eqn.~\ref{eqn:chap3-tallies-general} with the exact flux specified at all points in phase space. Instead, \ac{MC} performs stochastic integration by sampling the particle population across the entirety of phase space to compute a \textit{statistical estimate} $\hat{\mathcal{T}}$ of the true integral $\mathcal{T}$.

There are a number of different techniques to estimate a tally. The first and most general method is known as an \textit{analog estimator}. An analog estimator $\hat{\mathcal{T}}$ increments a tally by the particle weight $w_{i}$ each time an event $i$ occurs from the set of all events of interest $A$ (\textit{e.g.}, fission events). The sum of particle weights is then normalized by the total weight of all particles $W$ to compute the interaction frequency on a per-particle basis within the phase space volume of interest:

\begin{dmath}
\label{eqn:chap3-tallies-analog}
\hat{\mathcal{T}} = \frac{1}{W}\displaystyle\sum\limits_{i \in A} w_{i}
\end{dmath}

Although analog estimators permit general filters and scoring functions, they may suffer from poor tallying efficiency if the size of set $A$ is very small compared to the total number of events in a simulation. A \textit{collision estimator} improves the tallying efficiency by incrementing a tally more frequently than is possible with analog estimators. In particular, a collision estimator increments a tally at each collision $i$ from the set of all collisions $C$ irregardless of the types of collisions that took place. By noting that the total collision rate is given by $R_{t} = \Sigma_{t}\phi$, a collision estimator for the flux $\hat{\phi}$ may be simply defined by dividing the particle weights by the total macroscopic cross section:

\begin{dmath}
\label{eqn:chap3-tallies-collision-flux}
\hat{\phi} = \frac{1}{W}\displaystyle\sum\limits_{i \in C}\frac{w_{i}}{\Sigma_{t}(E_{i})}
\end{dmath}

\noindent The collision estimator depends on the energy of the incoming particle $E_{i}$ in order to scale the particle weight by the energy-dependent total cross section. It follows that the collision estimator for a reaction rate $\hat{\mathcal{R}}_{x}$ is the product of the flux in Eqn.~\ref{eqn:chap3-tallies-collision-flux} and the cross section for the reaction type $x$ of interest:

\begin{dmath}
\label{eqn:chap3-tallies-collision-rxn}
\hat{\mathcal{R}}_{x} = \frac{1}{W}\displaystyle\sum\limits_{i \in C}\frac{w_{i}\Sigma_{x}(E_{i})}{\Sigma_{t}(E_{i})}
\end{dmath}

The collision estimator increases the number of events in $C$ to improve the tallying efficiency with respect to analog tallies. A third known as \textit{track-length estimators} goes one step further and increments a tally each time a particle trajectory crosses the phase space of interest (\textit{e.g.}, a spatial tally mesh zone) even if a collision did not take place. The track-length estimator makes use of a particle's distance travelled $\Delta\mathbf{r}$ to estimate the flux. A track-length estimator of the flux is therefore:

\begin{dmath}
\label{eqn:chap3-tallies-tracklength-flux}
  \hat{\phi} = \frac{1}{W}\displaystyle\sum\limits_{i \in T}w_{i}\Delta\mathbf{r}_{i}
\end{dmath}

\noindent where the set $T$ represents each particle trajectory through the phase space volume of interest. Similarly, a track-length estimate of a reaction rate $x$ can be found from simply multiplying the flux in Eqn.~\ref{eqn:chap3-tallies-tracklength-flux} by the cross section:

\begin{dmath}
\label{eqn:chap3-tallies-tracklength-rxn}
  \hat{\mathcal{R}}_{x} = \frac{1}{W}\displaystyle\sum\limits_{i \in T}w_{i}\Delta\mathbf{r}_{i}\Sigma_{x}(E_{i})
\end{dmath}

The tallying efficiency for track-length estimators is greatly improved by incrementing a tally for each particle trajectory. As a result, the confidence intervals are generally much tighter for track-length estimators than those for analog and collision estimators. 

Each of the three estimators -- analog, collision and track-length -- may be useful for different scenarios. Although track-length and collision estimators improve statistics over analog estimates, they cannot be employed for all types of filters. For example, track-length tallies may not be used if the scoring function requires information about the outgoing particle since this is not available unless a collision took place. As discussed in Sec.~\ref{sec:chap3-mgxs-gen}, a mixture of estimators which tradeoff generality with efficiency must be used to generate \ac{MGXS} from \ac{MC} tallies.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Sample Statistics}
\label{subsec:chap3-mc-stats}

As discussed in the preceding section, \ac{MC} performs stochastic integration with one of a number of different estimators. In each case, the tally estimator $\hat{\mathcal{T}}$ is computed as a sample mean of of all of the events or particle trajectories simulated. An unbiased estimate of the sample mean is given by:

\begin{equation}
\label{eqn:chap3-sample-mean}
\bar{x} = \frac{1}{N} \displaystyle\sum\limits_{i=1}^{N} x_{i}
\end{equation}

\noindent where each of the $N$ samples is given by a random variable $x_{i}$. For \ac{MC} codes that used batch-based statistics, such as OpenMC, $N$ is the number of batches of particles simulated and $x_{i}$ is the tally estimator for the $i$\textsuperscript{th} batch of particles. 

Each of the random variables $x_{i}$ is sampled from some probability distribution representative of the physics in the simulation. The sampling distribution is normal and $x_{i} \sim \mathcal{N}(\mu,\sigma^{2})$ where $\mathcal{N}(\mu,\sigma^{2})$ signifies a normal distribution with mean $\mu$ and variance $\sigma^{2}$ if each batch of particles is independent. An unbiased estimate of the variance $\sigma^{2}$ of the distribution from which the population $x_{i}$ is drawn may be estimated using Bessel's correction for the sample variance $s^{2}$:

\begin{equation}
\label{eqn:chap3-variance-sample}
s^{2} = \frac{1}{N-1}\displaystyle\sum\limits_{i=1}^{N}\left(x_{i} - \bar{x}\right)^{2}
\end{equation}

\noindent As $N \rightarrow \infty$ the population variance estimator will approach the true variance $\sigma^{2}$ of the underlying distribution. In the case of batch-based statistics, the variance $\sigma^{2}$ will be determined by the number of particles simulated per batch -- the more particle histories simulated per batch, the smaller $\sigma^{2}$ will be, and vice versa.

In general, it is more useful to quantify the uncertainty of a tally estimator than it is to compute the sample variance. The variance of the sample mean is representative of the distribution from which the random variable $\bar{x}$ is drawn and indicates the degree of confidence one may have in a tally estimator. By the Central Limit Theorem, the sample mean $\bar{x}$ will converge to the mean of a normal distribution if the samples $x_{i}$ are uncorrelated. An unbiased estimate of the variance of the sample mean can be derived from the Bienaym\'{e} formula to give:

\begin{equation}
\label{eqn:chap3-variance-mean}
s_{\bar{x}}^{2} = \frac{1}{N-1}\left(\frac{1}{N}\displaystyle\sum\limits_{i=1}^{N}
x_{i}^{2} - \bar{x}^2\right)
\end{equation}

The key observation is that the standard deviation of the sample mean varies as $s_{\bar{x}} \propto \nicefrac{1}{\sqrt{N}}$ if the samples $x_{i}$ are uncorrelated. This necessarily implies that the uncertainties on a tally estimator can be made arbitrarily small given enough simulated particle histories. However, recent studies have shown that batch-based tally estimators in eigenvalue calculations are not generally independent and identically distributed realizations due to correlated fission sources between batches~\cite{herman2014correlation,miao2016correlation}. 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{MGXS Generation with Monte Carlo}
\label{sec:chap3-mgxs-gen}

This section describes how multi-group cross sections may be computed using stochastic integration. Sec.~\ref{subsec:chap3-tally-types} outlines the types of OpenMC tallies needed to generate \ac{MGXS} for -- including the scores, filters and estimators for each tally -- and the arithmetic combinations used to combine different tallies. Sec.~\ref{subsec:chap3-uncertainty-prop} illustrates how the uncertainties of the \ac{MGXS} may be estimated using error propagation theory.


%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Tally Types Needed for \ac{MGXS} Libraries}
\label{subsec:chap3-tally-types}

The types of \ac{MGXS} needed to solve the neutron transport equation were outlined in Chap.~\ref{chap:mgxs}, including expressions for the transport corrected total cross section and scattering matrix, and the fission production cross section and spectrum. This section outlines the types of tallies needed to compute these \ac{MGXS}. It is important to note that the flux separability approximation (Sec.~\ref{subsec:chap2-angle}) is applied in the tally formulations for each of the group constants.

\subsubsection{Inner Product Notation}
\label{subsec:chap3-tally-types-notation}

The following sections use angle bracket notation $\langle \cdot , \cdot \rangle$ to represent inner products in phase space. This may correspond to integrals over incoming and/or outgoing energy, space, and angle. Using this notation, a tally estimator for reaction rate $x$ is represented as follows: 

\begin{equation}
\label{eqn:chap3-inner-prod-notation}
\langle \Sigma_x, \psi \rangle = \int_{V} \int_{S} \int_{E} \Sigma_{x}(\mathbf{r},E)\psi(\mathbf{r},E,\mathbf{\Omega}) \mathrm{d}E\mathrm{d}\mathbf{\Omega}\mathrm{d}\mathbf{r}
\end{equation}

\noindent This notation is specialized throughout this section with subscripts to indicate the subsets of phase space that are integrated over in the inner product. In particular, subscript $k$ refers to a volume integral over $V_{k}$ for some region of space $k$ for spatial homogenization (Sec.~\ref{subsec:chap2-space}), while subscript $g$ corresponds to an integral over energies with $E \in [E_{g}, E_{g-1}]$ for energy condensation (Sec.~\ref{subsec:chap2-energy}). For example, the microscopic reaction rate for reaction $x$ by nuclide $i$ is denoted as:

\begin{equation}
\label{eqn:chap3-angle-rxn-rate}
\langle \sigma_{x,i}, \psi \rangle_{k,g} = \int_{\mathbf{r} \in V_{k}} \int_{4\pi} \int_{E_{g}}^{E_{g-1}} \sigma_{x,i}(\mathbf{r},E)\psi(\mathbf{r},E,\mathbf{\Omega}) \mathrm{d}E\mathrm{d}\mathbf{\Omega}\mathrm{d}\mathbf{r}
\end{equation}

\noindent The inner product of a function with unity, such as the spatially homogenized and energy-integrated flux is denoted by:

\begin{equation}
\label{eqn:chap3-angle-flux}
\langle \psi \rangle_{k,g} \equiv \langle \psi, \mathbb{1} \rangle_{k,g} = \int_{\mathbf{r} \in V_{k}} \int_{4\pi} \int_{E_{g}}^{E_{g-1}} \psi(\mathbf{r},E,\mathbf{\Omega}) \mathrm{d}E\mathrm{d}\mathbf{\Omega}\mathrm{d}\mathbf{r}
\end{equation}

Finally, the superscripts $a$ and $t\ell$ are given to those inner products computed with analog and track-length estimators, respectively -- \textit{i.e.}, $\langle \cdot,\cdot \rangle^{a}$ is an analog tally estimator and $\langle \cdot,\cdot \rangle^{t\ell}$ is a track-length tally estimator of the corresponding inner products.


\subsubsection{General Reaction Cross Section}
\label{subsubsec:chap3-gen-xs}

A general spatially homogenized and energy condensed macroscopic multi-group cross section for reaction $x$, spatial zone $k$, energy group $g$ can be computed with track-length tally estimators in OpenMC. The \ac{MGXS} is simply the ratio of the group-wise reaction rates $\langle \Sigma_{x}, \psi \rangle_{k,g}^{t\ell}$ and fluxes $\langle \Sigma_{x}, \psi \rangle_{k,g}^{t\ell}$:

\begin{equation}
\label{eqn:chap3-general-macro}
\hat{\Sigma}_{x,k,g} = \frac{\langle \Sigma_{x}, \psi \rangle_{k,g}^{t\ell}}{\langle \psi \rangle_{k,g}^{t\ell}}
\end{equation}

\noindent Likewise, a microscopic \ac{MGXS} for nuclide $i$ can be computed as follows:

\begin{equation}
\label{eqn:chap3-general-micro}
\hat{\sigma}_{x,i,k,g} = \frac{\langle \sigma_{x,i}, \psi \rangle_{k,g}^{t\ell}}{\langle \psi \rangle_{k,g}^{t\ell}}
\end{equation}

These estimators are used for reaction types which are only dependent on the incoming energy of a neutron, such as total and radiative capture reactions.


\subsubsection{Total Cross Section}
\label{subsubsec:chap3-tally-types-tot-xs}

The total macroscopic cross section $\Sigma_{t}$ is a special case of Eqn.~\ref{eqn:chap3-general-micro}, with track-length estimators for the total collision rate and flux:

\begin{equation}
\label{eqn:chap3-total-macro}
\hat{\Sigma}_{t,k,g} = \frac{\langle \Sigma_{t}, \psi \rangle_{k,g}^{t\ell}}{\langle \psi \rangle_{k,g}^{t\ell}}
\end{equation}

As discussed in Sec.~\ref{subsec:chap2-transport-corr}, a transport correction is often used to incorporate anisotropic scattering effects into the transport equation with an isotropic scattering kernel. An expression for the in-scatter approximation~\cite{yamamoto2008simplified} to the transport correction can be computed with an OpenMC tally for the first Legendre scattering moment\footnote{It is assumed that scattering multiplicity is included in the scattering moments as discussed in Sec.~\ref{sec:chap2-scatt-prod}.}. The inner product for this tally is given by:

\begin{equation}
\label{eqn:chap3-sigs1}
\langle \Sigma_{s1}, \psi \rangle_{k,g'\rightarrow g} = \int_{\mathbf{r} \in V_{k}} \int_{4\pi} \int_{E_{g}}^{E_{g-1}} \int_{E_{g'}}^{E_{g'-1}} \Sigma_{s1}(\mathbf{r},E'\rightarrow E)\psi(\mathbf{r},E',\mathbf{\Omega}) \mathrm{d}E'\mathrm{d}E\mathrm{d}\mathbf{\Omega}\mathrm{d}\mathbf{r}
\end{equation}

\noindent An analog estimator must be used in OpenMC since the tally includes an integral over the outgoing neutron energy. The spatially homogenized and energy condensed transport corrected total cross section given in Eqn.~\ref{eqn:chap2-transport-xs} is computed by summing over all incoming energy groups:

\begin{equation}
\label{eqn:chap3-transport-corr-macro}
\Delta\hat{\Sigma}_{tr,k,g} = \displaystyle\sum\limits_{g'=1}^{G} \langle{\Sigma_{s1}, \psi \rangle_{k,g'\rightarrow g}^{a}}
\end{equation}

\noindent The transport correction is then subtracted from the group-wise total collision rate and normalized by the flux to compute the transport-corrected total cross section:

\begin{equation}
\label{eqn:chap3-sigt-transport-macro}
\hat{\tilde{\Sigma}}_{t,k,g} = \frac{\langle \Sigma_{t}, \psi \rangle_{k,g}^{a} - \Delta\hat{\Sigma}_{tr,k,g}}{\langle \psi \rangle_{k,g}^{a}}
\end{equation}

\noindent Note that since the transport correction must be computed using an analog estimator, the total collision and flux in Eqn.~\ref{eqn:chap3-sigt-transport-macro} must also be computed with analog estimators.


\subsubsection{Scattering Matrix}
\label{subsubsec:chap3-tally-types-scatt-mat}

The isotropic scattering matrix is computed with an inner product of scattering reactions over both incoming and outgoing energies. An analog estimator must be used since the integral is dependent on the neutron's outgoing energy. Similar to the first Legendre moment in Eqn.~\ref{eqn:chap3-sigs1}, the isotropic scattering moment is given by the following expression:

\begin{equation}
\label{eqn:chap3-sigs0}
\langle \Sigma_{s0}, \psi \rangle_{k,g'\rightarrow g} = \int_{\mathbf{r} \in V_{k}} \int_{4\pi} \int_{E_{g}}^{E_{g-1}} \int_{E_{g'}}^{E_{g'-1}} \Sigma_{s0}(\mathbf{r},E'\rightarrow E)\psi(\mathbf{r},E,\mathbf{\Omega}) \mathrm{d}E'\mathrm{d}E\mathrm{d}\mathbf{\Omega}\mathrm{d}\mathbf{r}
\end{equation}

\noindent The isotropic scattering matrix is then:

\begin{equation}
\label{eqn:chap3-scatter-macro}
\hat{\Sigma}_{s,k,g} = \frac{\langle \Sigma_{s0}, \psi \rangle_{k,g'\rightarrow g}^{a}}{\langle \psi \rangle_{k,g'}^{a}}
\end{equation}

\noindent The transport correction in Eqn.~\ref{eqn:chap3-transport-corr-macro} can be applied by subtracting it off the diagonal elements in the matrix to compute the transport-corrected scattering matrix:

\begin{equation}
\label{eqn:chap3-scatter-trans-macro}
\hat{\tilde{\Sigma}}_{s,k,g'\rightarrow g} = \frac{\langle \Sigma_{s0}, \psi \rangle_{k,g'\rightarrow g}^{a} - \delta_{g,g'} \Delta\hat{\Sigma}_{tr,k,g}}{\langle \psi \rangle_{k,g'}^{a}}
\end{equation}

%\begin{equation}
%\label{eqn:chap3-scatter-trans-macro}
%\hat{\tilde{\Sigma}}_{s,k,g'\rightarrow g} = \frac{\langle \Sigma_{s0}, \psi \rangle_{k,g'\rightarrow g}^{a} - \delta_{g,g'} \displaystyle\sum\limits_{g''=1}^{G} \langle{\Sigma_{s1}, \psi \rangle_{k,g''\rightarrow g}^{a}}}{\langle \psi \rangle_{k,g'}^{a}}
%\end{equation}


\subsubsection{Fission Production Cross Section}
\label{subsubsec:chap3-tally-types-fiss-prod}

The fission production cross section was condensed in Eqn.~\ref{eqn:chap2-nusifg} to make it independent of the energies of the neutrons emitted from fission. It is therefore straightforward to treat the fission product macroscopic cross section $\nu\Sigma_{f}$ as a special case of Eqn.~\ref{eqn:chap3-general-micro}, with track-length estimators for the total collision rate and flux:

\begin{equation}
\label{eqn:chap3-nu-fiss-macro}
\nu\hat{\Sigma}_{f,k,g} = \frac{\langle \nu\Sigma_{f}, \psi \rangle_{k,g}^{t\ell}}{\langle \psi \rangle_{k,g}^{t\ell}}
\end{equation}


\subsubsection{Fission Energy Spectrum}
\label{subsubsec:chap3-tally-types-chi}

Unlike the fission production cross section, the fission spectrum is dependent on the outgoing neutron energy and must be computed with analog estimators. The fission production matrix from group $g$ into group $g'$ is given by the following inner product:

\begin{equation}
\label{eqn:chap3-nu-fiss-energies}
\langle \nu\Sigma_{f}, \psi \rangle_{k,g'\rightarrow g} = \int_{\mathbf{r} \in V_{k}} \int_{4\pi} \int_{E_{g}}^{E_{g-1}} \int_{E_{g'}}^{E_{g'-1}} \nu\Sigma_{f}(\mathbf{r},E'\rightarrow E)\psi(\mathbf{r},E,\mathbf{\Omega}) \mathrm{d}E'\mathrm{d}E\mathrm{d}\mathbf{\Omega}\mathrm{d}\mathbf{r}
\end{equation}

\noindent The fission spectrum in Eqn.~\ref{eqn:chap2-nusifg} can then be computed from this tally by summing over incoming and outgoing energy groups:

\begin{equation}
\label{eqn:chap3-nu-fiss-macro}
\hat{\chi}_{k,g} = \frac{\displaystyle\sum\limits_{g'=1}^{G} \langle \nu\Sigma_{f}, \psi \rangle_{k,g'\rightarrow g}^{a}}{\displaystyle\sum\limits_{g=1}^{G} \displaystyle\sum\limits_{g'=1}^{G} \langle \nu\Sigma_{f}, \psi \rangle_{k,g'\rightarrow g}^{a}}
\end{equation}

\noindent This expression for the fission spectrum will result in a normalized discrete probability distribution for the energy of neutrons emitted from fission.


\subsubsection{Summary}
\label{subsubsec:chap3-tally-types-summary}

The tallies needed to generate \ac{MGXS} libraries were outlined in detail in the preceding sections, and are summarized in Table~\ref{table:chap3-tally-types}. The scores and filters correspond to the notation used by the OpenMC code to describe the scoring function and integration bounds used in Eqn.~\ref{eqn:chap3-tallies-general}. 
The energy group structure for energy condensation is specified by \texttt{energy} and/or \texttt{energyout} filters in the table. The regions for spatial homogenization are specified by \texttt{material} or \texttt{cell} filters, although this could potentially include \texttt{universe}, \texttt{distribcell} and \texttt{mesh} filters as well.

%\renewcommand{\arraystretch}{1.5}

\begin{table}[h!]
  \centering
  \caption[Tally types for \ac{MGXS} generation]{The types of tallies used in \ac{MGXS} generation with OpenMC.}
  \scriptsize
  \label{table:chap3-tally-types}
  \vspace{6pt}
  \begin{tabular}{ m{1.3cm} m{1cm} m{2cm} m{2.5cm} m{2.5cm} m{1.5cm} }
  \toprule
  {\bf Name} &
  {\bf Symbol} &
  {\bf Tally} &
  {\bf Score} &
  {\bf Filters} &
  {\bf Estimator} \\

  \specialrule{.2em}{.1em}{.1em}

  \multirow{2}{*}[-0.7em]{\bf General} & \multirow{2}{*}[-0.7em]{$\hat{\Sigma}_{x,k,g}$} & $\langle \Sigma_{x}, \psi \rangle_{k,g}$ & reaction $x$ & \parbox{2cm}{\texttt{material}/\texttt{cell} \texttt{energy}} & \texttt{tracklength} \\
  \cline{3-6}
  & & $\langle \psi \rangle_{k,g}$ & {\texttt{flux}} & \parbox{2cm}{\texttt{material}/\texttt{cell} \texttt{energy}} & \texttt{tracklength} \\

  \specialrule{.2em}{.1em}{.1em}

  \multirow{2}{*}[-0.7em]{\bf Total} & \multirow{2}{*}[-0.7em]{$\hat{\Sigma}_{t,k,g}$} & $\langle \Sigma_{t}, \psi \rangle_{k,g}$ & \texttt{total} & \parbox{2cm}{\texttt{material}/\texttt{cell} \texttt{energy}} & \texttt{tracklength} \\
  \cline{3-6}
  & & $\langle \psi \rangle_{k,g}$ & \texttt{flux} & \parbox{2cm}{\texttt{material}/\texttt{cell} \texttt{energy}} & \texttt{tracklength} \\

  \specialrule{.2em}{.1em}{.1em}

  \multirow{3}{*}[-1em]{\parbox{1.5cm}{\bf Transport-Corrected Total}} & \multirow{3}{*}[-1em]{$\hat{\tilde{\Sigma}}_{t,k,g}$} & $\langle \Sigma_{t}, \psi \rangle_{k,g}$ & \texttt{total} & \parbox{2cm}{\texttt{material}/\texttt{cell} \texttt{energy}} & \texttt{analog} \\
  \cline{3-6}
  & & $\langle \Sigma_{s1}, \psi \rangle_{k,g'\rightarrow g}$ & \texttt{nu-scatter-1} & \parbox{2cm}{\texttt{material}/\texttt{cell} \texttt{energyout}} & \texttt{analog} \\
  \cline{3-6}
  & & $\langle \psi \rangle_{k,g}$ & \texttt{flux} & \parbox{2cm}{ \texttt{material}/\texttt{cell} \texttt{energy}} & \texttt{analog} \\

  \specialrule{.2em}{.1em}{.1em}

  \multirow{2}{*}[-0.5em]{\parbox{1.5cm}{\bf Scattering Matrix}} & \multirow{2}{*}[-0.5em]{$\hat{\Sigma}_{s,k,g}$} & $\langle \Sigma_{s0}, \psi \rangle_{k,g'\rightarrow g}$ & \texttt{nu-scatter-0} & \parbox{2cm}{\texttt{material}/\texttt{cell} \texttt{energy} \texttt{energyout}} & \texttt{analog} \\
  \cline{3-6}
  & & $\langle \psi \rangle_{k,g}$ & \texttt{flux} & \parbox{2cm}{\texttt{material}/\texttt{cell} \texttt{energy}} & \texttt{analog} \\

  \specialrule{.2em}{.2em}{.2em}

  \multirow{3}{*}[-1em]{\parbox{1.5cm}{\bf Transport-Corrected Scattering Matrix}} & \multirow{3}{*}[-1em]{$\hat{\Sigma}_{s,k,g}$} & $\langle \Sigma_{s0}, \psi \rangle_{k,g'\rightarrow g}$ & \texttt{nu-scatter-0} & \parbox{2cm}{\texttt{material}/\texttt{cell} \texttt{energy} \texttt{energyout}} & \texttt{analog} \\
  \cline{3-6}
  & & $\langle \Sigma_{s1}, \psi \rangle_{k,g'\rightarrow g}$ & \texttt{nu-scatter-1} & \parbox{2cm}{\texttt{material}/\texttt{cell} \texttt{energyout}} & \texttt{analog} \\
  \cline{3-6}
  & & $\langle \psi \rangle_{k,g}$ & \texttt{flux} & \parbox{2cm}{\texttt{material}/\texttt{cell} \texttt{energy}} & \texttt{analog} \\

  \specialrule{.2em}{.1em}{.1em}

  \multirow{2}{*}[-0.5em]{\parbox{1.5cm}{\bf Fission \hspace{1cm} Production}} & \multirow{2}{*}[-0.5em]{$\hat{\nu\Sigma}_{f,k,g}$} & $\langle \nu\Sigma_{f}, \psi \rangle_{k,g}$ & \texttt{nu-fission} & \parbox{2cm}{\texttt{material}/\texttt{cell} \texttt{energy}} & \texttt{tracklength} \\
  \cline{3-6}
  & & $\langle \psi \rangle_{k,g}$ & \texttt{flux} & \parbox{2cm}{\texttt{material}/\texttt{cell} \texttt{energy}} & \texttt{tracklength} \\

  \specialrule{.2em}{.1em}{.1em}
  
  \parbox{1.5cm}{\bf Fission Spectrum} & $\hat{\chi}_{k,g}$ & $\langle \nu\Sigma_{f}, \psi \rangle_{k,g'\rightarrow g}$ & \texttt{nu-fission} & \parbox{2cm}{\texttt{material}/\texttt{cell} \texttt{energy} \texttt{energyout}} & \texttt{analog} \\
  \midrule

\end{tabular}
\end{table}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Uncertainty Propagation}
\label{subsec:chap3-uncertainty-prop}

As discussed in the preceding sections, \ac{MGXS} may be computed using arithmetic combinations of tally estimators for reaction rates and fluxes. Each tally estimator is a random variable with an associated uncertainty estimated by the variance of the sample mean in Eqn.~\ref{eqn:chap3-variance-mean}. As a result, each multi-group cross section computed for a spatial zone and energy group is itself a random variable from a distribution with some unknown variance. It is therefore usefult to estimate the uncertainty of \ac{MGXS} computed from \ac{MC} tallies in order to quantify whether the \ac{MGXS} are known with enough precision for accurate multi-group calculations. 

Estimates for the variance may be deduced from standard error propagation theory. Such analysis is widely discussed in the literature~\cite{bevington2003data}. A few key equations necessary to estimate the variance for \ac{MGXS} are presented here. The arithmetic combinations of interest for \ac{MGXS} generation include addition, subtraction, multiplication and division. 

Consider two random variables $X$ and $Y$, generated from distributions with variances $\sigma_{X}^2$ and $\sigma_{Y}^2$ which are arithmetically combined into a new random variable $Z$ with variance $\sigma_{Z}^2$. The random variables $X$ and $Y$ may correspond to tallies for reaction rates and the flux, while $Z$ could correspond to a \ac{MGXS}. If $X$ is simply multiplied by some constant scalar $a$ to compute $Z$, then the variance $\sigma_{Z}^{2}$ is given by the following relation:

\vspace{-0.1in}

\begin{equation}
\label{eqn:chap3-scalar-mult}
Z = aX \qquad\Rightarrow\qquad \sigma_{Z}^{2} = a^{2}\sigma_{X}^{2}
\end{equation}

\noindent More generally, the following expressions can be derived for the variance $\sigma_{Z}^{2}$ for binary combinations of $X$ and $Y$:

\vspace{-0.4in}

\begin{align*}
Z &= X + Y & \sigma_{Z}^{2} &= \sigma_{X}^{2} + \sigma_{Y}^{2} + 2\sigma_{XY} \numberthis \label{eqn:chap3-add} \\
Z &= X - Y & \sigma_{Z}^{2} &= \sigma_{X}^{2} + \sigma_{Y}^{2} - 2\sigma_{XY} \numberthis \label{eqn:chap3-sub} \\
Z &= XY & \sigma_{Z}^{2} &\approx Z^{2}\left[\left(\frac{\sigma_{X}}{X}\right)^{2} + \left(\frac{\sigma_{Y}}{Y}\right)^{2} + 2\frac{\sigma_{XY}}{Z}\right] \numberthis \label{eqn:chap3-mult} \\
Z &= \frac{X}{Y} & \sigma_{Z}^{2} &\approx Z^{2}\left[\left(\frac{\sigma_{X}}{X}\right)^{2} + \left(\frac{\sigma_{Y}}{Y}\right)^{2} - 2\frac{\sigma_{XY}}{Z}\right] \numberthis \label{eqn:chap3-div} \\
\end{align*}

\vspace{-0.4in}

\noindent These expresssions are given in terms of the covariance $\sigma_{XY}$ of $X$ and $Y$:

\vspace{-0.1in}

\begin{equation}
\label{eqn:chap3-covariance}
\sigma_{XY} = \mathbb{E}[(X - \mathbb{E}[X])(Y - \mathbb{E}[Y])]
\end{equation}

\noindent where $\mathbb{E}$ is the expectation operator. The covariance is not generally computable using the standard formulation for a tally estimator in a Monte Carlo simulation. Although it would be possible to estimate the covariance using ensemble statistics\footnote{The covariance could be estimated from the results of an ensemble of independent \ac{MC} simulations.}, this is not often feasible. Instead, the covariance terms in Eqns.~\Crefrange{eqn:chap3-add}{eqn:chap3-div} are typically neglected. In general, the random variables for reaction rates and fluxes in the same volume of phase space are highly correlated, and neglecting the covariance leads to a poor approximation for the variance of \ac{MGXS}. However, it should be noted that division is the primary operation needed to combine tallies to compute \ac{MGXS}. Since the reaction rates and flux tallies have a positive correlation, the covariance term in Eqn.~\ref{eqn:chap3-div} reduces the estimate of the covariance. It therefore follows that a conservative estimate of the variance for \ac{MGXS} will be obtained by neglecting the covariance.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{A Literature Review of MGXS Generation with MC}
\label{sec:chap3-lit-review}

The last two decades have seen growing interest in Monte Carlo as a means to generate \ac{MGXS} libraries. This section presents a brief overview of the literature which document these efforts. As discussed in Sec.~\ref{subsec:chap3-lit-review-diffusion}, most of the work to date has been directed at generating homogenized few group constants for coarse mesh diffusion-based codes. Sec.~\ref{subsec:chap3-lit-review-transport} reviews a few recent theses which develop \ac{MC}-based methods to generate \ac{MGXS} for fine mesh transport-based simulations, which is the motivation for this thesis.


\subsection{MGXS for Coarse Mesh Diffusion Calculations}
\label{subsec:chap3-lit-review-diffusion}

Most \ac{MC}-based \ac{MGXS} generation schemes to date focus on generating few group constants for coarse mesh diffusion codes\footnote{In this context, \textit{coarse mesh} refers to the use of one or a few homogenized mesh cells per assembly.}. These schemes aim to improve the accuracy of standard diffusion codes for analysis of atypical core configurations for which the simplifications made by multi-level deterministic \ac{MGXS} generation methods are not necessarily applicable. These efforts replace the separate resonance self-shielding and deterministic lattice physics calculation steps in multi-level approaches (see Sec.~\ref{subsec:chap2-mgxs-lib-std-approach}) with fully-detailed \ac{MC} calculations of each assembly to compute the few group constants needed by whole core diffusion codes. The widely used Serpent \ac{MC} code discussed in Sec.~\ref{subsec:chap3-lit-review-diffusion-serpent} has led this trend over the last decade, and a few authors have applied MCNP in a similar fashion as highlighted in Sec.~\ref{subsec:chap3-lit-review-diffusion-mcnp}.

%-shortcomings
%  -requires specialized formulations of diffusion coefficients
%  -requires specialized leakage models (e.g., B1)
%*consider jaakko's arguments for this in his thesis


\subsubsection{Serpent}
\label{subsec:chap3-lit-review-diffusion-serpent}

Serpent is a continuous energy Monte Carlo code developed by the VTT Technical Research Centre of Finland, and is one of the most widely used \ac{MC} particle transport codes in the world~\cite{serpent2013manual}. Serpent was initially created as part of Lepp{\"a}nen's thesis~\cite{leppanen2007serpent} to generate few group constants for nodal diffusion codes. More recently, Serpent has since developed into a general purpose reactor physics burnup code with features including isotopic depletion, on-the-fly Doppler broadening and support for CAD geometries.

Serpent is designed to be a drop-in replacement for deterministic resonance self-shielding and lattice physics calculation codes and can generate homogenized few group constants for coarse mesh sub-assembly geometries. Serpent is uniquely designed for coarse mesh \ac{MGXS} generation since it uses the Woodcock-Delta method~\cite{woodcock1965techniques} to greatly reduce the computational expense of tracking particles in geometries with complicated surface crossings. Unlike deterministic multi-level approaches, Serpent uses \ac{MC} to precisely model self-shielding effects in complicated geometries. In addition, Serpent simplifies the validation of downstream diffusion codes which use the \ac{MGXS} it generates since it is also capable of computing whole-core reference solutions.

One of the challenges for lattice physics calculations is the appropriate treatment of net current between assemblies. In order to address this, Serpent employs a two-step energy condensation scheme including an infinite-lattice calculation followed by a B$_{1}$ leakage correction~\cite{fridman2011serpent}. The scheme first performs an infinite-lattice calculation for each unique assembly and first tallies \ac{MGXS} in the WIMS 69-group structure. The \ac{MGXS} are used to form the B$_{1}$ equations for the homogenized system which are solved for the critical flux spectrum accounting for inter-assembly leakage. The critical flux is finally used to collapse the 69-group \ac{MGXS} into few group constants. Although the B$_{1}$ equations make assumptions that are not always be true -- such as an energy-independent buckling -- the approach has been demonstrated to largely resolve 20\% errors in 2-group diffusion coefficients compared to those collapsed with the infinite flux for simple \ac{PWR} benchmarks~\cite{fridman2011serpent}. However, the B$_{1}$ leakage correction does have some known deficiencies, including its inability to treat non-fissile regions such as homogenized reflectors or transmutation cross sections in burnup calculations~\cite{leppanen2016overview}.

Much of the research focus for Serpent has revolved around the need to accurately compute diffusion coefficients. Unlike the total, scattering, and fission production \ac{MGXS} discussed in Chap.~\ref{chap:mgxs}, diffusion coefficients do not have a continuous energy counterpart in transport theory. Serpent uses an approximate method to compute the diffusion coefficient from the inverse of the transport cross section\footnote{This is an approximate method since the energy collapse of the transport cross section is not equivalent to the energy collapse of its inverse, which is what is needed to collapse the diffusion coefficient}. In particular, Serpent tallies a 69-group \ac{MGXS} transport cross section, and condenses its inverse with the B$_{1}$ leakage corrected spectra to compute diffusion coefficients. In addition, since it is not straightforward to compute current-weighted tallies in \ac{MC}, Serpent makes a heuristic approximation and uses a scalar flux-weighted scattering moment to compute the transport cross section (see Sec.~\ref{subsec:chap2-transport-corr}). More recently, the Serpent team has introduced Liu's novel Cumulative Migration Method (CMM)~\cite{liuphysor2016} to mitigate shortcomings in the current approach~\cite{leppanen2016overview} and to directly compute diffusion coefficients in any group structure.

Although Serpent is the most popular tool for \ac{MGXS} generation, its use thus far has been specifically directed for coarse mesh diffusion applications. To the author's knowledge, there have not yet been any published works which use Serpent to generate \ac{MGXS} for fine mesh transport calculations.

%In addition, as discussed in Sec.~\ref{subsec:chap2-transport-corr}, it is not is not a straighforward exercise to compute the transport cross section from Monte Carlo since it requires a first order current-weighted scattering moment matrix. Instead, Serpent makes a heuristic approximation and uses a scalar flux-weighted scattering moment to compute the transport cross section. 

\subsubsection{MCNP}
\label{subsec:chap3-lit-review-diffusion-mcnp}

-pounders~\cite{pounders2006stochastically}\\
-redmond as well??\\


\subsection{MGXS for Fine Mesh Transport Calculations}
\label{subsec:chap3-lit-review-transport}

Redmond~\cite{redmond1997multigroup} performed one of the earliest known in-depth analyses of \ac{MGXS} generation with \ac{MC} methods. Redmond studied two methods to compute group-to-group scattering moment matrices with the MCNP code~\cite{mcnpx2003manual}. The first approach -- known as the \textit{direct method} -- is equivalent to the analog estimator for computing scattering matrices presented in Sec.~\ref{subsubsec:chap3-tally-types-scatt-mat}. The second approach -- termed the \textit{explicit method} -- forces a finite sampling of possible outgoing energies and angles for each scattering and fission event. The explicit method may thereby improve the sampling statistics for the scattering cross section and the fission spectrum. To the author's knowledge, the explicit method is not implemented in any presently available production code nor are there results beyond Redmond's work which evaluate the sampling efficiency of the method.

%-not generally derived for all scattering laws (see page 67)

Like Redmond, Nelson~\cite{nelson2014improved} identified the convergence rate of scattering moments to be a key bottleneck to computing \ac{MGXS} libraries, and developed an approach to mitigate this with deterministic tallies of the energy and angle for outgoing neutrons in collisions. Nelson's methodology permits track-length estimators for tallies which depend on the outgoing neutron energy, and scores to all outgoing energy groups for each particle trajectory. This is advantageous since it greatly improves the tallying efficiency and convergence rate of scattering moment matrices and the fission energy spectrum. However, Nelson's methodology requires a computationally expensive pre-processing step to transform each nuclide's nuclear data for use in an \ac{MC} simulation. Furthermore, the pre-processing step is specific to the energy group structure used in an \ac{MGXS} library, and the computational expense and memory footprint grow as $\mathcal{O}(NG^{2})$ with the number of groups $G$ and nuclides $N$ in a simulation. Although Nelson implemented the scheme in a developmental version of OpenMC, it was not employed for this work.

Li Cai~\cite{cai2014condensation} investigated the use of the TRIPOLI-4 code to generate \ac{MGXS} with continuous energy Monte Carlo simulations. Unlike other published works, Cai validated the \ac{MGXS} using the multi-group Monte Carlo solver in TRIPOLI-4 rather than a deterministic multi-group solver. Her thesis primarily focused on methods to enforce neutron balance between reference continuous energy and multi-group Monte Carlo calculations. Cai developed a method termed the ``In-Group Scattering Correction'' (IGSC) as a means to mitigate the flux separability approximation discussed in Sec.~\ref{subsec:chap2-angle}. The IGSC technique employs volumetric neutron current-weighted moments of the total cross section as correction terms to the diagonal entries in the scattering moment matrices. 

%Cai evaluated two approximations to the neutron current with their corresponding \ac{MC} estimators for a variety of homogenized 2D and 3D fast reactor benchmarks. Although the IGSC method appeared to improve the consistency between continuous energy and multi-group \ac{MC} results for some cases, it led to a several thousand \ac{PCM} eigenvalue bias for a few of the benchmarks. Furthermore, Cai's results demonstrated the of approximating volumetric currents within a heterogeneous geometry with strongly varying material properties. Finally, Cai's methodology 

Cai explored IGSC with a \ac{MC} estimator of Todorova's current approximation for a variety of homogenized 2D and 3D fast reactor benchmarks. Although the IGSC method improved the consistency between continuous energy and multi-group \ac{MC} results for some cases, it led to a several thousand \ac{PCM} eigenvalue bias for a few of the benchmarks. Furthermore, Cai's results demonstrated the deficiency of using Todorova's current approximatoin in a heterogeneous geometry with strongly varying material properties. Cai developed and evaluated an alternative approximation to the current, termed the ``Direction-X'' current, to eliminate the approximations made in Todorova's current -- namely, that the gradient of the flux is similar to the flux spectrum itself. Although the ``Direction-X'' current greatly improved the results with respect to Todorova's current, its implementation and analysis was limited to 1D slab geometries.


what's left? me\\
---------------\\


\begin{itemize}[noitemsep]
  \item \ac{MGXS} for coarse mesh diffusion
  \begin{itemize}[noitemsep]
    \item Pounders
    \item Serpent
    \item others
  \end{itemize}
\end{itemize}