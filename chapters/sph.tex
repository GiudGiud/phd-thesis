\chapter{SuPerHomog\'{e}n\'{e}isation Factors}
\label{chap:sph}

The results in Chapter~\ref{chap:biases} demonstrated that using the ``true'' flux spectrum from Monte Carlo to perform energy condensation and spatial homogenization will not necessarily result in accurate deterministic multi-group calculations. Large systematic biases in the eigenvalue were observed for simple heterogeneous benchmark models. In Section~\ref{sec:chap5-diagnosis} it was shown that the bias largely derives from errors in the multi-group reaction rates in the large thermal U-238 capture resonances. These results indicate that one or more of the approximations made in multi-group transport theory are invalidated in heterogeneous geometries and prevent an appropriate treatment of spatial self-shielding at the fuel/moderator interface in \ac{PWR} geometries.

%, and that the errors systematically vary in space within the fuel.

%, and these biases were highly dependent on the energy group structure and spatial discretization used in the multi-group deterministic calculation.

Chap.~\ref{chap:mgxs} discussed approximations made in multi-group theory to simplify the neutron transport equation in angle, energy and space. Many of these approximations were quantitatively studied in Chap.~\ref{chap:biases} -- including energy group structure, spatial discretization mesh, and isotropic scattering -- yet it was demonstrated that none of these led to the eigenvalue bias. This chapter investigates the flux separability approximation as the dominant factor contributing to the eigenvalue bias.

Sec~\ref{sec:chap6-angular-mgxs} reviews some recent work by by Gibson~\cite{gibson2016thesis} to quantify the approximation error resolved with angular-dependent \ac{MGXS}, which closely mirrors the trends observed in Chap.~\ref{chap:biases}. The historical \ac{SPH} factor concept is introduced in the context of angular-dependent \ac{MGXS} in Sec.~\ref{sec:chap6-sph}, and \ac{SPH} factors are applied to simple heterogeneous benchmarks and the results analyzed in Sec.~\ref{sec:chap6-sph}. Finally, this chapter concludes with a summary of the shortcomings of the \ac{SPH} approach and the need for new methods to account for the angular dependence in \ac{MGXS}.

%first paragraph: motivate problem
%-mention bias from nelson/yoshikoka 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Angular-Dependent MGXS}
\label{sec:chap6-angular-mgxs}

The flux separability approximation introduced in Sec.~\ref{subsec:chap2-angle} led to the use of the scalar rather than the angular flux to condense the total cross section in energy. The mathematically proper treatment would instead use the angular flux to condense the total \ac{MGXS} in angle, energy and space, resulting in angular-dependent total \ac{MGXS}. Flux separability is commonly used since conventional \ac{MGXS} generation schemes are generally incapable of approximating the angular dependence of the flux. Nevertheless, flux separability is an approximation which may lead to non-trivial errors in downstream multi-group calculations, such as the eigenvalue bias observed in Chap.~\ref{chap:biases}. 

The flux separability approximation will necessarily hold in infinite homogeneous media -- such as that considered in Sec.~\ref{subsec:chap5-inf-medium} -- since the flux does not vary in angle or space. However, the flux may vary greatly by angle in a heterogeneous geometry with significant spatial self-shielding. For example, consider the flux from two different directions impinged upon the \ac{FSR} for one radial ring and angular sector in a fuel pin in Fig.~\ref{fig:chap6-incoming-outgoing}. The flux entering from the moderator will be unshielded and will likely be quite similar to the $\nicefrac{1}{E}$ asymptotic spectrum. In contrast, the flux which traverses the fuel pin will be signficantly depressed in the resonant groups. As a result, the reaction rates for the incoming flux will be greater than those for the outgoing flux in resonant groups, which would be reflected in angular-dependent total \ac{MGXS}.

\begin{figure}[h]
  \centering
  \includegraphics[width=\linewidth]{figures/sph/incoming-outgoing}
  \caption[Angular flux impinged on an FSR]{Angular flux impinged on an FSR from the moderator (top) and after traversing the fuel (bottom). \textit{Image courtesy of N. Gibson~\cite{gibson2016thesis}.}}
\label{fig:chap6-incoming-outgoing}
\end{figure}

A recent PhD thesis by Gibson~\cite{gibson2016thesis} studied the impact of using angular-dependent total \ac{MGXS} on multi-group calculations to avoid the flux separability approximation. Gibson was motivated by his observation of reaction rate errors similar to those discovered in Sec.~\ref{sec:chap5-diagnosis}. In particular, he solved for the reference ultra-fine flux for a 2D \ac{PWR} fuel pin given a fixed source. The reference scalar flux was used to condense the continuous energy total cross sections to 69-group \ac{MGXS}, which were employed in a second fixed source transport calculation. The reaction rates computed from the ultra-fine and 69-group scalar fluxes differed by up to 1\% for low-lying energy groups with large U-238 capture resonances, with an error profile in energy similar to that in Fig.~\ref{fig:chap5-rel-err-energy}. Gibson's results indicated that an improper treatment of self-shielding effects in heterogeneous geometries may lead to errors in resonant groups even when the exact scalar flux is used to collapse cross sections in energy and space.

Gibson further investigated this issue by using the reference ultra-fine angular flux to compute angular-dependent \ac{MGXS}. Some examples of the angular-dependent capture \ac{MGXS} generated for two different \ac{FSR}s shaded in dark gray are shown in Fig.~\ref{fig:chap6-batman-plots}. The \ac{MGXS} in the \ac{FSR} at the fuel/moderator interface in Fig.~\ref{fig:chap6-batman-plots-a} ranges from less than 5 to more than 30 barns for angles entering and leaving the fuel pin. The peaks near 60$^{\circ}$ and 120$^{\circ}$ are due to extra moderation experienced by neutrons streaming through the infinite rectilinear fuel pin lattice at those angles. The \ac{MGXS} in \ac{FSR}s in the interior of the fuel pin, such as the one shown in Fig.~\ref{fig:chap6-batman-plots-b}, exhibit similar but less prominent properties since the flux is shielded in all directions.

\begin{figure}[h]
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=\linewidth]{figures/sph/batman-1}
  \caption{}
  \label{fig:chap6-batman-plots-a}
\end{subfigure}
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=\linewidth]{figures/sph/batman-2}
  \caption{}
  \label{fig:chap6-batman-plots-b}
\end{subfigure}
\caption[Angular-dependent capture MGXS]{Angular-dependent capture \ac{MGXS} as a function of incoming azimuthal angle for two different \ac{FSR}s for the 6.67 eV resonance group. The radial axis is given in units of barns and the azimuthal axis in units of degrees. \textit{Image courtesy of N. Gibson~\cite{gibson2016thesis}.}}
\label{fig:chap6-batman-plots}
\end{figure}

Gibson proceeded to show that the angular-dependent total \ac{MGXS} eliminated the reaction rate errors observed with scalar flux-weighted \ac{MGXS}. His analysis highlighted the tight coupling between angular dependence and the spatial discretization. Notably, the reaction rate errors were reduced by an order of magnitude only when angular-dependent \ac{MGXS} were paired with a fine \ac{FSR} spatial discretization. This can be explained by the fact that the angular variation of the volume-integrated flux is diminished as the \ac{FSR} mesh is coarsened. Thus, the spatial self-shielding effects at the fuel/moderator interface cannot be captured by angular-dependent total \ac{MGXS} if the \ac{FSR} discretization is unable to distinguish between neutrons entering/leaving the fuel pin.

Although angular-dependent total \ac{MGXS} is the most direct solution to eliminate the flux separability approximation, it is not a desirable approach for a number of reasons. Angular-dependent \ac{MGXS} would significantly increase the memory footprint for \ac{MGXS} libraries, and be complicated to accommodate in multi-group methods. Furthermore, angular-dependent \ac{MGXS} is not attractive for \ac{MC}-based \ac{MGXS} generation since many more particle histories would be required to converge the \ac{MGXS} in each discrete angular tally bin. The Consistent-P approximation~\cite{bell1967transport} is an alternative method that embeds the angular dependence of the total \ac{MGXS} within the angular expansion of the scattering kernel (Eqn.~\ref{eqn:chap2-transport-ce-2}) while retaining an angular independent total \ac{MGXS}. Although the Consistent-P approximation is one viable approach used in many transport codes, it was not evaluated here since anisotropic scattering was not implemented in OpenMOC at the time of this writing. A third method known SuPerHomog\'{e}n\'{e}isation factors was discussed in this context by Gibson, who employed them to reduce heterogeneous resonant reaction rate errors (albeit to a lesser extent than he achieved with angular-depenent total \ac{MGXS}). \ac{SPH} factors are a relatively simple-to-implement method which do not require an anisotropic scattering kernel implementation. For this reason, the \ac{SPH} factor scheme was evaluated in OpenMOC as discussed in the following sections.

%-Nelson's 1D slab plot(s)?


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{SuPerHomog\'{e}n\'{e}isation Factors}
\label{sec:chap6-sph}

As discussed in Chap.~\ref{chap:mgxs}, multi-group theory is valid and consistent if and only if \ac{MGXS} are defined to preserve reaction rates. In Chap.~\ref{chap:biases} it was determined that reaction rate preservation is not possible in heterogeneous geometries, even if the exact flux from \ac{MC} is used to collapse the cross sections in energy and space. \ac{SPH} factors were first proposed by H\'{e}bert~\cite{hebert1993consistent} to preserve reaction rates during energy condensation and spatial homogenization. The \ac{SPH} factor algorithm requires knowledge of a reference source that is used in a multi-group fixed source solver to derive multiplicative factors that adjust the total \ac{MGXS} to force neutron balance. 

The literature provides little explanation of the type of approximation errors that \ac{SPH} factors is designed to mitigate. In theory, the \ac{SPH} scheme will adjust \ac{MGXS} to preserve reaction rates irregardless of the source of approximation error -- including errors which derive from a poor treatment of energy and spatial self-shielding, a coarse spatial discretization of the multi-group calculation method, and/or a truncated approximation to the anisotropic scattering kernel. In this section, \ac{SPH} factors are investigated as one approach to resolve the reaction rate errors observed in Chap.~\ref{chap:biases}. The mathematical formulation behind \ac{SPH} factors is described in Sec.~\ref{subsec:chap6-sph-overview}, the iterative algorithm used to compute the factors is summarized in Sec.~\ref{subsec:chap6-sph-algorithm}, and the implementation of \ac{SPH} factors in OpenMOC is highlighted in Sec.~\ref{subsec:chap6-sph-openmoc}.

%%%%%%%%%%%%%%%%%%%%%
\subsection{Overview}
\label{subsec:chap6-sph-overview}

The \ac{SPH} algorithm enforces reaction rate preservation between a reference fine mesh transport problem and a corresponding coarse mesh transport or diffusion problem in energy and space. \ac{SPH} factors have traditionally been applied to spatially-homognenized few-group \ac{MGXS} for coarse mesh diffusion applications. However, this section will introduce \ac{SPH} factors to enforce equivalence between continuous energy Monte Carlo and deterministic multi-group transport methods. 

The \ac{SPH} scheme postulates the existence of a set of factors $\mu_{k,g}$ for each spatial zone $k$ and energy group $g$ which force the streaming and collision terms in the transport equation to balance with a fixed source $Q_{k,g}$:

\begin{dmath}
\label{eqn:chap6-sph-transport-eqn}
\mathbf{\Omega} \cdot \nabla \psi_{g}(\mathbf{r},\mathbf{\Omega}) + \mu_{k,g}\Sigma_{t,k,g}\psi_{g}(\mathbf{r},\mathbf{\Omega}) = Q_{k,g}(\mathbf{\Omega})
\end{dmath}

\noindent In this equation, the \ac{SPH} factors are applied to correct the total \ac{MGXS} in each region and group. The fixed source $Q_{k,g}$ is computed from the reference fine mesh solution. In this case,  the fixed source is treated as the sum of scattering and fission production sources in each energy group and spatial zone. For example, continuous energy Monte Carlo can be used to compute reference multi-group fluxes and \ac{MGXS}, which are then combined to compute an isotropic source as follows:

\begin{dmath}
\label{eqn:chap6-sph-source}
Q_{k,g}(\mathbf{\Omega}) = \frac{1}{4\pi} \sum_{g'=1}^{G} \Sigma_{s,k,g' \rightarrow g}\phi_{k,g'} + \frac{\chi_{k,g}}{4\pi k_{eff}}\sum_{g'=1}^{G} \nu\Sigma_{f,k,g'}\phi_{k,g'}
\end{dmath}

\noindent Given the fixed source and total \ac{MGXS} from \ac{MC}, Eqn.~\ref{eqn:chap6-sph-transport-eqn} may be solved using any multi-group transport method, such as \ac{MOC}. The challenge is to devise estimates $\hat{mu}_{k,g}$ to the true \ac{SPH} factors $\mu_{k,g}$ which adequately preserve reaction rates. The following section describes the iterative scheme used to estimate \ac{SPH} factors.

%%%%%%%%%%%%%%%%%%%%%
\subsection{Algorithm}
\label{subsec:chap6-sph-algorithm}

An iterative algorithm is used to estimate \ac{SPH} factors from a series of multi-group fixed source calculations. First, the estimates $\hat{\mu}_{k,g}^{(n)}$ to the true \ac{SPH} factors $\mu_{k,g}$ at iteration $n$ are introduced into Eqn.~\ref{eqn:chap6-sph-transport-eqn}:

\begin{dmath}
\label{eqn:chap6-sph-transport-eqn-iterate}
\mathbf{\Omega} \cdot \nabla \psi_{g}^{(n)}(\mathbf{r},\mathbf{\Omega}) + \hat{\mu}_{k,g}^{(n-1)}\Sigma_{t,k,g}\psi_{g}^{(n)}(\mathbf{r},\mathbf{\Omega}) = Q_{k,g}(\mathbf{\Omega})
\end{dmath}

\noindent A solution to the multi-group flux distribution is computed for each iteration. The \ac{SPH} factor estimates $\hat{\mu}_{k,g}^{(n)}$ are found from the ratio of the reference Monte Carlo scalar flux $\phi_{k,g}^{MC}$ to the flux $\phi_{k,g}^{(n)}$ computed from the fixed source calculation at iteration $n$,

\begin{equation}
\label{eqn:chap6-sph-update}
\hat{\mu}_{k,g}^{(n)} = \frac{\phi_{k,g}^{MC}}{\phi_{k,g}^{(n)}}
\end{equation}

\noindent where the factors are initialized to unity on the first iteration:

\begin{dmath}
\label{eqn:chap6-sph-initial}
\hat{\mu}_{k,g}^{(0)} = 1
\end{dmath}

The \ac{SPH} factors are used to find a total \ac{MGXS} which forces neutron balance in Eqn.~\ref{eqn:chap6-sph-transport-eqn-iterate}. The total \ac{MGXS} $\Sigma_{t,k,g}^{(0)}$ is computed from the reference \ac{MC} flux and total reaction rate tallies. The \ac{SPH} factors are then used to obtain a corrected total \ac{MGXS} $\Sigma_{t,k,g}^{(n)}$ on each iteration:

\begin{dmath}
\label{eqn:chap6-sph-update-sigt}
\Sigma_{t,k,g}^{(n)} = \hat{\mu}_{k,g}^{(n-1)}\Sigma_{t,k,g}^{(0)}
\end{dmath}

The series of fixed source problems defined by Eqn.~\ref{eqn:chap6-sph-transport-eqn-iterate} are solved until the \ac{SPH} factors converge. A common convergence criterion is the maximum relative absolute deviation across energy groups and spatial zones:

\begin{dmath}
\label{eqn:chap6-sph-residual}
res = \max_{k,g} \left|\frac{\hat{\mu}_{k,g}^{(n)} - \hat{\mu}_{k,g}^{(n-1)}}{\hat{\mu}_{k,g}^{(n-1)}}\right|
\end{dmath}

\noindent Typically a residual of 1E-6 can be achieved with twenty or fewer iterations.

The scattering matrix $\Sigma_{s,k,g'\rightarrow g}$ and fission production cross section $\nu\Sigma_{f,k,g}$ are used to compute the reference fixed source in Eqn.~\ref{eqn:chap6-sph-source}, but are not needed in the iterative scheme defined in Eqn.~\ref{eqn:chap6-sph-transport-eqn-iterate}. However, in the context of this thesis, \ac{SPH} factors are computed to preserve reaction rates in subsequent eigenvalue calculations. Therefore, the \ac{SPH} factors must be applied to the scattering matrix and fission production cross section to derive a fully-corrected \ac{MGXS} library:

\begin{dmath}
\label{eqn:chap6-sph-update-sigs}
\Sigma_{s,k,g'\rightarrow g}^{(n)} = \hat{\mu}_{k,g}^{(n-1)}\Sigma_{s,k,g'\rightarrow g}^{(0)}
\end{dmath}

\begin{dmath}
\label{eqn:chap6-sph-update-nusigf}
\nu\Sigma_{f,k,g}^{(n)} = \hat{\mu}_{k,g}^{(n-1)}\nu\Sigma_{f,k,g}^{(0)}
\end{dmath}

It should be noted that although the \ac{SPH}-corrected \ac{MGXS} are defined to preserve reaction rates, they will not preserve the group-wise scalar flux. However, the angular or scalar flux may be easily recovered from the fluxes $\tilde{\psi}_{k,g}$ and $\tilde{\phi}_{k,g}$ computed with the corrected \ac{MGXS} in an eigenvalue or fixed source calculation:

\begin{dmath}
\label{eqn:chap6-sph-update-angular-flux}
\psi_{k,g} = \hat{\mu}_{k,g}\tilde{\psi}_{k,g}
\end{dmath}

\begin{dmath}
\label{eqn:chap6-sph-update-scalar-flux}
\phi_{k,g}^{(n)} = \hat{\mu}_{k,g}\tilde{\phi}_{k,g}
\end{dmath}

The \ac{SPH} iteration algorithm described here is summarized in Alg.~\ref{alg:chap6-sph}. It should be noted that as presently posed, there is no unique solution to the set of \ac{SPH} factors which preserve reaction rates. However, a unique solution may be found by forcing the factors to be unity in non-fissile zones (\textit{e.g.}, moderator, clad and gap). This approach is motivated by the fact that resonances which lead to self-shielding errors -- such as the U-238 capture resonances studied in Sec.~\ref{subsec:chap2-angle} -- are generally from isotopes in the fuel.

\begin{algorithm}[h]
\caption{SPH Factor Algorithm}
\label{alg:chap6-sph}
\begin{algorithmic}[1]
  \State Initialize $\Sigma_{t,k,g}^{(0)}$, $\Sigma_{s,k,g'\rightarrow g}^{(0)}$, $\nu\Sigma_{f,k,g}^{(0)}$, and $\chi_{k,g}^{(0)}$ from MC tallies \Comment{Tab.~\ref{table:chap3-tally-types}}
  \State Compute $Q_{k,g}$ from MC flux and \ac{MGXS} \Comment{Eqn.~\ref{eqn:chap6-sph-source}}
  \State Initialize $\hat{\mu}_{k,g}^{(0)}$ to unity
  \While{SPH factors are not converged}
    \State Update $\Sigma_{t,k,g}$ with \ac{SPH} factors \Comment{Eqn.~\ref{eqn:chap6-sph-update-sigt}}
    \State Solve fixed source transport problem\footnotemark \Comment{Eqn.~\ref{eqn:chap6-sph-transport-eqn-iterate}}
    \State Compute new \ac{SPH} factors \Comment{Eqn.~\ref{eqn:chap6-sph-update}}
    \State Compute \ac{SPH} factor residuals \Comment{Eqn.~\ref{eqn:chap6-sph-residual}}
  \EndWhile
  \State Compute final \ac{MGXS} with \ac{SPH} factors \Comment{Eqn.~\Crefrange{eqn:chap6-sph-update-sigt}{eqn:chap6-sph-update-nusigf}}
\end{algorithmic}
\end{algorithm}

\footnotetext{A series of $G$ independent fixed source problems may be solved for each of the $G$ groups. Alternatively, a single fixed source problem may simultaneously solve for all $G$ groups, as is done in OpenMOC.}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Implementation in OpenMOC}
\label{subsec:chap6-sph-openmoc}

The \ac{SPH} scheme was implemented in the \texttt{openmoc.materialize} Python module of the OpenMOC code (see Sec.~\ref{subsubsec:chap4-openmoc-mgxs}). The \ac{SPH} algorithm was specifically implemented to work with the \texttt{Library} class included in the \texttt{openmc.mgxs} Python module for \ac{MGXS} generation with OpenMC (see Sec.~\ref{subsec:chap4-mgxs}). In particular, the fixed source in Eqn.~\ref{eqn:chap6-sph-source} is computed from the \ac{MC} tallies in the \texttt{Library} object and used to construct a fixed source simulation in OpenMOC. The \ac{MGXS} tabulated in the \texttt{Library} object are loaded into OpenMOC, and the series of fixed source calculations in Alg.~\ref{alg:chap6-sph} is managed from Python. The \ac{MGXS} data in the \texttt{Library} object is updated with the \ac{SPH} factors computed at each iteration. The final corrected \ac{MGXS} \texttt{Library} object, along with the \ac{SPH} factors, are returned to the user for use in subsequent OpenMOC eigenvalue calculations.

Although the \ac{SPH} algorithm is relatively simple, a few subtle issues made the implementation in OpenMOC less than straightforward. First, it should be noted that OpenMC tallies are \textit{volume-integrated}, while reaction rates and fluxes in OpenMOC are \textit{volume-averaged}. As a result, the \ac{MC} tallies must be normalized to the volume used by OpenMOC for each \ac{FSR}\footnote{OpenMOC estimates spatial volumes by integrating the characteristic track lengths across each \ac{FSR}.} to calculate the volume-averaged fixed source in each \ac{FSR}. In addition, it was relatively complicated to map the \ac{MGXS} data and \ac{SPH} factors between the combinatorial geometry meshes used by OpenMC and OpenMOC. These challenges notwithstanding, \ac{SPH} factors were implemented in OpenMOC v0.2.1, and used to reduce reaction rate errors as discussed in the following section.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Case Studies}
\label{sec:chap6-sph-case-studies}

first paragraph: intro case studies
-SPH applied to heterogeneous benchmarks from Chap. 5
-itemize covergence criterion
-fixed source criterion in openmoc
-fission source criterion in openmoc
-identify the metrics that will be presented in what follows:
  -reduction in the eigenvalue bias
  -SPH factors in energy and in space

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Improvement in Eigenvalue}
\label{subsubsec:chap6-sph-eigenvalues}

first paragraph: intro case studies
-varying energy group structures
-varying \ac{FSR} discretizations
-refer back to Tables in Chap. 5
-iso-in-lab scattering

second paragraph: synthesis
-review consistency in eigenvalue
-summarize percent improvement in the eigenvalue

\begin{table}[h!]
  \centering
  \caption[Eigenvalues with SPH factors for a 1D slab]{The impact of SPH factors on the eigenvalue bias $\Delta\rho$ with varying energy group structures and \ac{FSR} spatial discretizations for a 1D slab.}  
  \label{table:chap6-sph-slab-energy} 
  \vspace{6pt}
  \begin{tabular}{| q | S[table-format=6.1] S[table-format=6.1] S[table-format=6.1] S[table-format=6.1] S[table-format=6.1] |}
  \hhline{~|-----|}
  \multicolumn{1}{c|}{\cellcolor{white}} & \multicolumn{5}{c|}{\cellcolor{lightgray} {\bf \ac{FSR} Discretization}} \\
  \multicolumn{1}{c|}{\cellcolor{white}} &
  {\cellcolor{lightgray} {\bf 1$\times$}} &
  {\cellcolor{lightgray} {\bf 2$\times$}} &
  {\cellcolor{lightgray} {\bf 4$\times$}} &
  {\cellcolor{lightgray} {\bf 8$\times$}} &
  {\cellcolor{lightgray} {\bf 16$\times$}} \\
  \midrule
  \multicolumn{1}{|c|}{\cellcolor{lightgray} {\bf \# Groups}} & \multicolumn{5}{c|}{\cellcolor{carolinablue} \bf Without SPH} \\
  \hhline{~|-----|}
1 & 139 & 97 & 127 & 162 & 140 \\
2 & 296 & 145 & 100 & 90 & 88 \\
4 & 233 & 125 & 77 & 61 & 51 \\
8 & 304 & 136 & 45 & 7 & -9 \\
16 & 329 & 139 & 38 & -6 & -23 \\
25 & 266 & 83 & -11 & -54 & -70 \\
40 & 270 & 75 & -29 & -73 & -89 \\
70 & 280 & 76 & -33 & -81 & -93 \\
%1 & 134 & 92 & 121 & 156 & 134 \\
%2 & 384 & 228 & 179 & 168 & 165 \\
%4 & 236 & 125 & 74 & 57 & 47 \\
%8 & 304 & 132 & 39 & -1 & -17 \\
%16 & 329 & 136 & 31 & -15 & -32 \\
%25 & 247 & 61 & -37 & -81 & -97 \\
%40 & 249 & 51 & -56 & -102 & -118 \\
%70 & 258 & 51 & -61 & -111 & -123 \\
  \midrule
  \multicolumn{1}{c|}{\cellcolor{white}} & \multicolumn{5}{c|}{\cellcolor{lightgreen} \bf With SPH} \\
  \midrule
1 & 33 & -10 & 18 & 51 & 30 \\
2 & 36 & 13 & 27 & 34 & 16 \\
4 & 18 & 26 & 28 & 33 & 18 \\
8 & 27 & 37 & 29 & 22 & 12 \\
16 & 27 & 38 & 30 & 20 & 9 \\
25 & 28 & 39 & 34 & 25 & 12 \\
40 & 28 & 39 & 31 & 23 & 12 \\
70 & 31 & 41 & 31 & 20 & 13 \\
%1 & 33 & -10 & 18 & 52 & 31 \\
%2 & 37 & 13 & 25 & 31 & 13 \\
%4 & 16 & 23 & 24 & 28 & 12 \\
%8 & 25 & 34 & 24 & 16 & 6 \\
%16 & 25 & 35 & 25 & 14 & 3 \\
%25 & 26 & 36 & 29 & 20 & 7 \\
%40 & 26 & 36 & 27 & 17 & 6 \\
%70 & 30 & 38 & 27 & 15 & 7 \\
  \bottomrule
\end{tabular}
\end{table}

\begin{table}[h!]
  \centering
  \caption[Eigenvalues with SPH factors for a 2D fuel pin]{The impact of SPH factors on the eigenvalue bias $\Delta\rho$ with varying energy group structures and \ac{FSR} spatial discretizations for a 2D fuel pin.}
  \label{table:chap6-sph-pin-energy} 
  \vspace{6pt}
  \begin{tabular}{| q | S[table-format=6.1] S[table-format=6.1] S[table-format=6.1] S[table-format=6.1] S[table-format=6.1] |}
  \hhline{~|-----|}
  \multicolumn{1}{c|}{\cellcolor{white}} & \multicolumn{5}{c|}{\cellcolor{lightgray} {\bf \ac{FSR} Discretization}} \\
  \multicolumn{1}{c|}{\cellcolor{white}} &
  {\cellcolor{lightgray} {\bf 1$\times$}} &
  {\cellcolor{lightgray} {\bf 2$\times$}} &
  {\cellcolor{lightgray} {\bf 4$\times$}} &
  {\cellcolor{lightgray} {\bf 8$\times$}} &
  {\cellcolor{lightgray} {\bf 16$\times$}} \\
  \midrule
  \multicolumn{1}{|c|}{\cellcolor{lightgray} {\bf \# Groups}} & \multicolumn{5}{c|}{\cellcolor{carolinablue} \bf Without SPH} \\
  \hhline{~|-----|}
1 & 80 & 92 & 55 & 83 & 66 \\
2 & 141 & 87 & 29 & 50 & 34 \\
4 & 27 & -15 & -43 & -45 & -57 \\
8 & 26 & -34 & -85 & -90 & -102 \\
16 & 35 & -35 & -91 & -101 & -111 \\
25 & -31 & -105 & -158 & -170 & -182 \\
40 & -38 & -114 & -174 & -189 & -202 \\
70 & -39 & -117 & -182 & -196 & -211 \\
%1 & 91 & 92 & 92 & 92 & 92 \\
%2 & 153 & 109 & 78 & 67 & 68 \\
%4 & 31 & -9 & -38 & -51 & -59 \\
%8 & 31 & -29 & -75 & -95 & -106 \\
%16 & 41 & -26 & -79 & -103 & -114 \\
%25 & -27 & -91 & -142 & -169 & -177 \\
%40 & -34 & -103 & -159 & -187 & -196 \\
%70 & -35 & -106 & -165 & -195 & -204 \\
  \midrule
  \multicolumn{1}{c|}{\cellcolor{white}} & \multicolumn{5}{c|}{\cellcolor{lightgreen} \bf With SPH} \\
  \midrule
1 & 19 & 25 & -18 & 10 & -14 \\
2 & 25 & 20 & -14 & 18 & -6 \\
4 & 7 & 10 & 2 & 12 & 1 \\
8 & 4 & 13 & -0 & 12 & 2 \\
16 & 5 & 13 & 0 & 10 & 4 \\
25 & 5 & 13 & 2 & 12 & -1 \\
40 & 4 & 16 & 3 & 11 & -2 \\
70 & 4 & 17 & 2 & 12 & -3 \\
%1 & 6 & 6 & 6 & 6 & 6 \\
%2 & 32 & 32 & 32 & 32 & 32 \\
%4 & 7 & 7 & 7 & 7 & 7 \\
%8 & 5 & 5 & 5 & 5 & 5 \\
%16 & 6 & 6 & 6 & 6 & 6 \\
%25 & 8 & 8 & 8 & 8 & 8 \\
%40 & 7 & 7 & 7 & 7 & 7 \\
%70 & 8 & 8 & 8 & 8 & 8 \\
  \bottomrule
\end{tabular}
\end{table}

\begin{figure}[H]
\begin{subfigure}{.9\textwidth}
  \centering
  \includegraphics[width=\linewidth]{figures/sph/slab/rel-err-fuel-fsrs}
  \caption{}
\end{subfigure}
\begin{subfigure}{.9\textwidth}
  \centering
  \includegraphics[width=\linewidth]{figures/sph/slab/rel-err-fuel-fsrs}
  \caption{}
\end{subfigure}
\caption[Flux relative error by FSR w/ SPH]{The spatially-varying relative error of the OpenMOC scalar flux with respect to the reference OpenMC flux for a 1D slab (a) and 2D fuel pin (b) in group 27. The results correspond to Tables~\ref{table:chap5-slab-space} and~\ref{table:chap5-pin-space}.}
\label{fig:chap6-rel-err-space}
\end{figure}


\begin{figure}[h!]
\begin{subfigure}{.9\textwidth}
  \centering
  \includegraphics[width=\linewidth]{figures/sph/slab/rel-err-inner-outer}
  \caption{}
\end{subfigure}
\begin{subfigure}{.9\textwidth}
  \centering
  \includegraphics[width=\linewidth]{figures/sph/slab/rel-err-inner-outer}
  \caption{}
\end{subfigure}
\caption[Flux relative error by energy group w/ SPH]{The energy-dependent relative error of the OpenMOC scalar flux with respect to the reference OpenMC flux in a 1D slab (a) and 2D fuel pin (b). The results correspond to the case studies presented in Tables~\ref{table:chap5-slab-space} and~\ref{table:chap5-pin-space}.}
\label{fig:chap6-rel-err-energy}
\end{figure}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{SPH Factors in Energy}
\label{subsubsec:chap6-sph-energy}

first paragraph: intro case studies
-this will mirror Sec. 5.2.1
-inspected SPH factors by energy group
-do SPH factors demonstrate similar profile to errors in Fig. 5.4?
-looked at innermost and outermost FSRs

FLUX PLOTS HERE [W/ AND W/O SPH]
-red and blue, solid and dashed lines
-both pin and slab

\begin{figure}[h!]
\begin{subfigure}{.9\textwidth}
  \centering
  \includegraphics[width=\linewidth]{figures/sph/slab/sph-inner-outer}
  \caption{}
\end{subfigure}
\begin{subfigure}{.9\textwidth}
  \centering
  \includegraphics[width=\linewidth]{figures/sph/slab/sph-inner-outer}
  \caption{}
\end{subfigure}
\caption[SPH factors by energy group]{The energy-dependent relative error of the OpenMOC scalar flux with respect to the reference OpenMC flux in a 1D slab (a) and 2D fuel pin (b). The results correspond to the case studies presented in Tables~\ref{table:chap5-slab-space} and~\ref{table:chap5-pin-space}.}
\label{fig:chap6-sph-energy}
\end{figure}

second paragraph: synthesis
-describe what you see
-improvement in all energy groups
-difference in profiles for innermost/outermost FSRs

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{SPH Factors in Space}
\label{subsubsec:chap6-sph-space}

first paragraph: intro case studies
-this will mirror Sec. 5.2.2
-inspected SPH factors by spatial location (fuel FSRs only)
-do SPH factors demonstrate similar profile to errors in Fig. 5.5?
-looked at group 27 only

FLUX PLOTS HERE [W/ AND W/O SPH]
-both pin and slab
-red and blue, solid and dashed lines
-groups 27, 29, and 30? and 28?

\begin{figure}[H]
\begin{subfigure}{.9\textwidth}
  \centering
  \includegraphics[width=\linewidth]{figures/sph/slab/sph-fuel-fsrs}
  \caption{}
\end{subfigure}
\begin{subfigure}{.9\textwidth}
  \centering
  \includegraphics[width=\linewidth]{figures/sph/slab/sph-fuel-fsrs}
  \caption{}
\end{subfigure}
\caption[SPH factors by FSR]{The spatially-varying relative error of the OpenMOC scalar flux with respect to the reference OpenMC flux for a 1D slab (a) and 2D fuel pin (b) in group 27. The results correspond to Tables~\ref{table:chap5-slab-space} and~\ref{table:chap5-pin-space}.}
\label{fig:chap6-sph-space}
\end{figure}

second paragraph: synthesis
-describe what you see
-compare spatial variation of SPH across pin to the error profile plot
-any differences b/w pin and slab


%-plot of Nelson's flux/angular-dependent MGXS???
%-eigenvalues if SPH factors for only group 27 are applied

%\begin{table}[h!]
%  \centering
%  \caption[SPH factors for a 1D slab]{SPH factors in the energy group encompassing the U-238 capture resonance at 6.67 eV for different energy group structures. The SPH factors were computed for a 1D slab and 2D fuel pin without spatial discretization and with ``iso-in-lab'' scattering.}
%  \small
%  \label{table:chap6-sph-group-27}
%  \vspace{6pt}
%  \begin{tabular}{c c S[table-format=2.1] S[table-format=2.1]}
%  \toprule
%  \multicolumn{1}{c}{\textbf{\# Groups}} &
%  \multicolumn{1}{c}{\textbf{Group 27}} &
%  \multicolumn{2}{c}{\textbf{SPH Factor $\mu$}} \\
%  \midrule
%  & & \multicolumn{1}{c}{\bf 1D Slab} &
%  \multicolumn{1}{c}{\bf 2D Fuel Pin} \\
%  \midrule
%1 & & & \\
%2 & & & \\
%4 & & & \\
%8 & & & \\
%16 & & & \\
%25 & & & \\
%40 & & & \\
%70 & & & \\
%  \bottomrule
%\end{tabular}
%\end{table}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\subsection{2D Heterogeneous Fuel Assembly}
%\label{subsec:chap6-sph-hetero-lat}

%\begin{itemize}[noitemsep]
%  \begin{itemize}[noitemsep]
%    \item cell-avg SPH, region-avg SPH, region-clustered (LNS?) SPH
%  \end{itemize}
%  \item bar chart / rug plot of SPH factors in resonance group(s)
%\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%
\section{Shortcomings of SPH}
\label{subsec:chap6-sph-shortcomings}

first paragraph: shortcomings
-specific to group structure, FSR mesh
-requires MC source on the FSR mesh
  -requires knowledge of the solution
-computationally expensive - slower convergence rate in MC
-unclear if SPH factors can be tabulated once and broadly applied

second paragraph: need for new method(s)
-must account for flux separability
-need to preserve reaction rates
-generalizable approach to embed angular info in MGXS